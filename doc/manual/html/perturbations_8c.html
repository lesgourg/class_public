<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CLASS MANUAL: perturbations.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CLASS MANUAL
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('perturbations_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">perturbations.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="perturbations_8h_source.html">perturbations.h</a>&quot;</code><br />
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Include dependency graph for perturbations.c:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="perturbations_8c__incl.png" border="0" usemap="#perturbations_8c" alt=""/></div>
<map name="perturbations_8c" id="perturbations_8c">
<area shape="rect" id="node2" href="perturbations_8h.html" title="perturbations.h" alt="" coords="424,79,534,104"/>
<area shape="rect" id="node3" href="thermodynamics_8h.html" title="thermodynamics.h" alt="" coords="255,152,385,177"/>
<area shape="rect" id="node18" href="evolver__ndf15_8h_source.html" title="evolver_ndf15.h" alt="" coords="517,225,633,251"/>
<area shape="rect" id="node20" href="evolver__rkck_8h_source.html" title="evolver_rkck.h" alt="" coords="425,152,532,177"/>
<area shape="rect" id="node4" href="background_8h.html" title="background.h" alt="" coords="244,225,346,251"/>
<area shape="rect" id="node5" href="common_8h.html" title="common.h" alt="" coords="346,372,430,397"/>
<area shape="rect" id="node13" href="quadrature_8h_source.html" title="quadrature.h" alt="" coords="22,299,119,324"/>
<area shape="rect" id="node15" href="arrays_8h_source.html" title="arrays.h" alt="" coords="260,299,330,324"/>
<area shape="rect" id="node16" href="dei__rkck_8h_source.html" title="dei_rkck.h" alt="" coords="447,299,529,324"/>
<area shape="rect" id="node17" href="parser_8h_source.html" title="parser.h" alt="" coords="353,299,423,324"/>
<area shape="rect" id="node11" href="svnversion_8h_source.html" title="svnversion.h" alt="" coords="527,445,623,471"/>
<area shape="rect" id="node19" href="sparse_8h_source.html" title="sparse.h" alt="" coords="604,299,676,324"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a6ff67e40c37f87b0bb60e31384c8d2f3"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a6ff67e40c37f87b0bb60e31384c8d2f3">perturb_sources_at_tau</a> (struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, int index_ic, int index_type, double tau, double *psource)</td></tr>
<tr class="separator:a6ff67e40c37f87b0bb60e31384c8d2f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c49cf2b10de95fbf09d8823bc37c512"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a8c49cf2b10de95fbf09d8823bc37c512">perturb_init</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a8c49cf2b10de95fbf09d8823bc37c512"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74076af3188daaaf4370ebe6d99467c7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a74076af3188daaaf4370ebe6d99467c7">perturb_free</a> (struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a74076af3188daaaf4370ebe6d99467c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18919a91db85f3b160f5c37652df8ad2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a18919a91db85f3b160f5c37652df8ad2">perturb_indices_of_perturbs</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a18919a91db85f3b160f5c37652df8ad2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a137c582541759d0b3b1e19c2cce403af"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a137c582541759d0b3b1e19c2cce403af">perturb_timesampling_for_sources</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a137c582541759d0b3b1e19c2cce403af"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0576a9234f137786c71ed0d39bd41a6a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a0576a9234f137786c71ed0d39bd41a6a">perturb_get_k_list</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a0576a9234f137786c71ed0d39bd41a6a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0133b10254da8e7e291758beeb2dbd1a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a0133b10254da8e7e291758beeb2dbd1a">perturb_workspace_init</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:a0133b10254da8e7e291758beeb2dbd1a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22780c266a622dbfd79041206ebfcd2b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a22780c266a622dbfd79041206ebfcd2b">perturb_workspace_free</a> (struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:a22780c266a622dbfd79041206ebfcd2b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb08128eaf97711c39a1c6b03de9d0c1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#afb08128eaf97711c39a1c6b03de9d0c1">perturb_solve</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, int index_ic, int index_k, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:afb08128eaf97711c39a1c6b03de9d0c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6030d94fa0132ba4aec2d0c1c8e0c8cc"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a6030d94fa0132ba4aec2d0c1c8e0c8cc">perturb_prepare_output</a> (struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt)</td></tr>
<tr class="separator:a6030d94fa0132ba4aec2d0c1c8e0c8cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae952f39862d329abce842e5ff0ccef1a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#ae952f39862d329abce842e5ff0ccef1a">perturb_find_approximation_number</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, double k, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw, double tau_ini, double tau_end, int *interval_number, int *interval_number_of)</td></tr>
<tr class="separator:ae952f39862d329abce842e5ff0ccef1a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32513f12869ecf15659266787513a9d6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a32513f12869ecf15659266787513a9d6">perturb_find_approximation_switches</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, double k, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw, double tau_ini, double tau_end, double <a class="el" href="common_8h.html#structprecision">precision</a>, int interval_number, int *interval_number_of, double *interval_limit, int **interval_approx)</td></tr>
<tr class="separator:a32513f12869ecf15659266787513a9d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af24f3c293aed6612641ff4f6bac63994"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#af24f3c293aed6612641ff4f6bac63994">perturb_vector_init</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, int index_ic, double k, double tau, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw, int *pa_old)</td></tr>
<tr class="separator:af24f3c293aed6612641ff4f6bac63994"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a640847cb9e0000f9556404ac7d0a49e8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a640847cb9e0000f9556404ac7d0a49e8">perturb_vector_free</a> (struct <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> *pv)</td></tr>
<tr class="separator:a640847cb9e0000f9556404ac7d0a49e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32fef60bdb0627ff3982d1d8185aa566"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a32fef60bdb0627ff3982d1d8185aa566">perturb_initial_conditions</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, int index_ic, double k, double tau, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:a32fef60bdb0627ff3982d1d8185aa566"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adc944c8e172833c9c18557e1508b828a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#adc944c8e172833c9c18557e1508b828a">perturb_approximations</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, double k, double tau, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:adc944c8e172833c9c18557e1508b828a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac25f59a7fd0f4f7eb58c5c2c4620eac6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#ac25f59a7fd0f4f7eb58c5c2c4620eac6">perturb_timescale</a> (double tau, void *parameters_and_workspace, double *timescale, ErrorMsg error_message)</td></tr>
<tr class="separator:ac25f59a7fd0f4f7eb58c5c2c4620eac6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac3d9fb29d84566ab67c69ee8d28a30c4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#ac3d9fb29d84566ab67c69ee8d28a30c4">perturb_einstein</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, double k, double tau, double *y, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:ac3d9fb29d84566ab67c69ee8d28a30c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a11f17fb88c32d9cadae8b74efac77b01"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a11f17fb88c32d9cadae8b74efac77b01">perturb_total_stress_energy</a> (struct <a class="el" href="common_8h.html#structprecision">precision</a> *ppr, struct <a class="el" href="background_8h.html#structbackground">background</a> *pba, struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *pth, struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *ppt, int index_md, double k, double *y, struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *ppw)</td></tr>
<tr class="separator:a11f17fb88c32d9cadae8b74efac77b01"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a846b00583c952e1d772d40e42bd38628"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a846b00583c952e1d772d40e42bd38628">perturb_sources</a> (double tau, double *y, double *dy, int index_tau, void *parameters_and_workspace, ErrorMsg error_message)</td></tr>
<tr class="separator:a846b00583c952e1d772d40e42bd38628"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7102d2605e166f2f2eaf5518aeab79fc"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a7102d2605e166f2f2eaf5518aeab79fc">perturb_print_variables</a> (double tau, double *y, double *dy, void *parameters_and_workspace, ErrorMsg error_message)</td></tr>
<tr class="separator:a7102d2605e166f2f2eaf5518aeab79fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa6f273487c3cc276a4db995051e850c1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#aa6f273487c3cc276a4db995051e850c1">perturb_derivs</a> (double tau, double *y, double *dy, void *parameters_and_workspace, ErrorMsg error_message)</td></tr>
<tr class="separator:aa6f273487c3cc276a4db995051e850c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2767b1841cc9aab30957347853d8db6d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="perturbations_8c.html#a2767b1841cc9aab30957347853d8db6d">perturb_tca_slip_and_shear</a> (double *y, void *parameters_and_workspace, ErrorMsg error_message)</td></tr>
<tr class="separator:a2767b1841cc9aab30957347853d8db6d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Documented perturbation module</p>
<p>Julien Lesgourgues, 23.09.2010</p>
<p>Deals with the perturbation evolution. This module has two purposes:</p>
<ul>
<li>at the beginning; to initialize the perturbations, i.e. to integrate the perturbation equations, and store temporarily the terms contributing to the source functions as a function of conformal time. Then, to perform a few manipulations of these terms in order to infer the actual source functions <img class="formulaInl" alt="$ S^{X} (k, \tau) $" src="form_185.png"/>, and to store them as a function of conformal time inside an interpolation table.</li>
<li>at any time in the code; to evaluate the source functions at a given conformal time (by interpolating within the interpolation table).</li>
</ul>
<p>Hence the following functions can be called from other modules:</p>
<ol type="1">
<li><a class="el" href="perturbations_8c.html#a8c49cf2b10de95fbf09d8823bc37c512">perturb_init()</a> at the beginning (but after <a class="el" href="background_8c.html#afeb0656453b92be39c60fb3fb1abd910">background_init()</a> and <a class="el" href="thermodynamics_8c.html#a1acbfae38edb0c73d8991645f89b2d13">thermodynamics_init()</a>)</li>
<li><a class="el" href="perturbations_8c.html#a6ff67e40c37f87b0bb60e31384c8d2f3">perturb_sources_at_tau()</a> at any later time</li>
<li><a class="el" href="perturbations_8c.html#a74076af3188daaaf4370ebe6d99467c7">perturb_free()</a> at the end, when no more calls to <a class="el" href="perturbations_8c.html#a6ff67e40c37f87b0bb60e31384c8d2f3">perturb_sources_at_tau()</a> are needed </li>
</ol>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a6ff67e40c37f87b0bb60e31384c8d2f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6ff67e40c37f87b0bb60e31384c8d2f3">&#9670;&nbsp;</a></span>perturb_sources_at_tau()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_sources_at_tau </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_ic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>psource</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Source function <img class="formulaInl" alt="$ S^{X} (k, \tau) $" src="form_185.png"/> at a given conformal time tau.</p>
<p>Evaluate source functions at given conformal time tau by reading the pre-computed table and interpolating.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppt</td><td>Input: pointer to perturbation structure containing interpolation tables </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of requested mode </td></tr>
    <tr><td class="paramname">index_ic</td><td>Input: index of requested initial condition </td></tr>
    <tr><td class="paramname">index_type</td><td>Input: index of requested source function type </td></tr>
    <tr><td class="paramname">tau</td><td>Input: any value of conformal time </td></tr>
    <tr><td class="paramname">psource</td><td>Output: vector (already allocated) of source function as a function of k </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>interpolate in pre-computed table contained in ppt </li>
</ul>

</div>
</div>
<a id="a8c49cf2b10de95fbf09d8823bc37c512"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c49cf2b10de95fbf09d8823bc37c512">&#9670;&nbsp;</a></span>perturb_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize the perturbs structure, and in particular the table of source functions.</p>
<p>Main steps:</p>
<ul>
<li>given the values of the flags describing which kind of perturbations should be considered (modes: scalar/vector/tensor, initial conditions, type of source functions needed...), initialize indices and wavenumber list</li>
<li>define the time sampling for the output source functions</li>
<li>for each mode (scalar/vector/tensor): initialize the indices of relevant perturbations, integrate the differential system, compute and store the source functions.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Output: Initialized perturbation structure </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>perform preliminary checks</li>
<li>initialize all indices and lists in perturbs structure using <a class="el" href="perturbations_8c.html#a18919a91db85f3b160f5c37652df8ad2">perturb_indices_of_perturbs()</a></li>
<li>define the common time sampling for all sources using <a class="el" href="perturbations_8c.html#a137c582541759d0b3b1e19c2cce403af">perturb_timesampling_for_sources()</a></li>
<li>if we want to store perturbations, write titles and allocate storage</li>
<li>create an array of workspaces in multi-thread case</li>
<li>loop over modes (scalar, tensors, etc). For each mode:</li>
<li>&ndash;&gt; (a) create a workspace (one per thread in multi-thread case)</li>
<li>&ndash;&gt; (b) initialize indices of vectors of perturbations with perturb_indices_of_current_vectors()</li>
<li>&ndash;&gt; (c) loop over initial conditions and wavenumbers; for each of them, evolve perturbations and compute source functions with <a class="el" href="perturbations_8c.html#afb08128eaf97711c39a1c6b03de9d0c1">perturb_solve()</a> </li>
</ul>

</div>
</div>
<a id="a74076af3188daaaf4370ebe6d99467c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a74076af3188daaaf4370ebe6d99467c7">&#9670;&nbsp;</a></span>perturb_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Free all memory space allocated by <a class="el" href="perturbations_8c.html#a8c49cf2b10de95fbf09d8823bc37c512">perturb_init()</a>.</p>
<p>To be called at the end of each run, only when no further calls to <a class="el" href="perturbations_8c.html#a6ff67e40c37f87b0bb60e31384c8d2f3">perturb_sources_at_tau()</a> are needed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppt</td><td>Input: perturbation structure to be freed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Stuff related to perturbations output:</p>
<ul>
<li>Free non-NULL pointers </li>
</ul>

</div>
</div>
<a id="a18919a91db85f3b160f5c37652df8ad2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a18919a91db85f3b160f5c37652df8ad2">&#9670;&nbsp;</a></span>perturb_indices_of_perturbs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_indices_of_perturbs </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize all indices and allocate most arrays in perturbs structure.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input/Output: Initialized perturbation structure </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>count modes (scalar, vector, tensor) and assign corresponding indices</li>
<li>allocate array of number of types for each mode, ppt-&gt;tp_size[index_md]</li>
<li>allocate array of number of initial conditions for each mode, ppt-&gt;ic_size[index_md]</li>
<li>allocate array of arrays of source functions for each mode, ppt-&gt;source[index_md]</li>
<li>initialization of all flags to false (will eventually be set to true later)</li>
<li>source flags and indices, for sources that all modes have in common (temperature, polarization, ...). For temperature, the term t2 is always non-zero, while other terms are non-zero only for scalars and vectors. For polarization, the term e is always non-zero, while the term b is only for vectors and tensors.</li>
<li>define k values with <a class="el" href="perturbations_8c.html#a0576a9234f137786c71ed0d39bd41a6a">perturb_get_k_list()</a></li>
<li>loop over modes. Initialize flags and indices which are specific to each mode.</li>
<li>(a) scalars</li>
<li>&ndash;&gt; source flags and indices, for sources that are specific to scalars</li>
<li>&ndash;&gt; count scalar initial conditions (for scalars: ad, cdi, nid, niv; for tensors: only one) and assign corresponding indices</li>
<li>(b) vectors</li>
<li>&ndash;&gt; source flags and indices, for sources that are specific to vectors</li>
<li>&ndash;&gt; initial conditions for vectors</li>
<li>(c) tensors</li>
<li>&ndash;&gt; source flags and indices, for sources that are specific to tensors</li>
<li>&ndash;&gt; only one initial condition for tensors</li>
<li>(d) for each mode, allocate array of arrays of source functions for each initial conditions and wavenumber, (ppt-&gt;source[index_md])[index_ic][index_type] </li>
</ul>

</div>
</div>
<a id="a137c582541759d0b3b1e19c2cce403af"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a137c582541759d0b3b1e19c2cce403af">&#9670;&nbsp;</a></span>perturb_timesampling_for_sources()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_timesampling_for_sources </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Define time sampling for source functions.</p>
<p>For each type, compute the list of values of tau at which sources will be sampled. Knowing the number of tau values, allocate all arrays of source functions.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input/Output: Initialized perturbation structure </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>allocate background/thermodynamics vectors</li>
<li>first, just count the number of sampling points in order to allocate the array containing all values</li>
<li>(a) if CMB requested, first sampling point = when the universe stops being opaque; otherwise, start sampling gravitational potential at recombination [however, if perturbed recombination is requested, we also need to start the system before recombination. Otherwise, the initial conditions for gas temperature and ionization fraction perturbations (delta_T = 1/3 delta_b, delta_x_e) are not valid].</li>
<li>(b) next sampling point = previous + ppr-&gt;perturb_sampling_stepsize * timescale_source, where:</li>
<li>&ndash;&gt; if CMB requested: timescale_source1 = <img class="formulaInl" alt="$ |g/\dot{g}| = |\dot{\kappa}-\ddot{\kappa}/\dot{\kappa}|^{-1} $" src="form_186.png"/>; timescale_source2 = <img class="formulaInl" alt="$ |2\ddot{a}/a-(\dot{a}/a)^2|^{-1/2} $" src="form_187.png"/> (to sample correctly the late ISW effect; and timescale_source=1/(1/timescale_source1+1/timescale_source2); repeat till today.</li>
<li>&ndash;&gt; if CMB not requested: timescale_source = 1/aH; repeat till today.</li>
<li>&ndash;&gt; infer total number of time steps, ppt-&gt;tau_size</li>
<li>&ndash;&gt; allocate array of time steps, ppt-&gt;tau_sampling[index_tau]</li>
<li>&ndash;&gt; repeat the same steps, now filling the array with each tau value:</li>
<li>&ndash;&gt; (b.1.) first sampling point = when the universe stops being opaque</li>
<li>&ndash;&gt; (b.2.) next sampling point = previous + ppr-&gt;perturb_sampling_stepsize * timescale_source, where timescale_source1 = <img class="formulaInl" alt="$ |g/\dot{g}| = |\dot{\kappa}-\ddot{\kappa}/\dot{\kappa}|^{-1} $" src="form_186.png"/>; timescale_source2 = <img class="formulaInl" alt="$ |2\ddot{a}/a-(\dot{a}/a)^2|^{-1/2} $" src="form_187.png"/> (to sample correctly the late ISW effect; and timescale_source=1/(1/timescale_source1+1/timescale_source2); repeat till today. If CMB not requested: timescale_source = 1/aH; repeat till today.</li>
<li>last sampling point = exactly today</li>
<li>loop over modes, initial conditions and types. For each of them, allocate array of source functions. </li>
</ul>

</div>
</div>
<a id="a0576a9234f137786c71ed0d39bd41a6a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0576a9234f137786c71ed0d39bd41a6a">&#9670;&nbsp;</a></span>perturb_get_k_list()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_get_k_list </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Define the number of comoving wavenumbers using the information passed in the precision structure.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to perturbation structure </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>allocate arrays related to k list for each mode</li>
<li>scalar modes</li>
<li>&ndash;&gt; find k_max (as well as k_max_cmb[ppt-&gt;index_md_scalars], k_max_cl[ppt-&gt;index_md_scalars])</li>
<li>&ndash;&gt; test that result for k_min, k_max make sense</li>
<li>vector modes</li>
<li>&ndash;&gt; find k_max (as well as k_max_cmb[ppt-&gt;index_md_vectors], k_max_cl[ppt-&gt;index_md_vectors])</li>
<li>&ndash;&gt; test that result for k_min, k_max make sense</li>
<li>tensor modes</li>
<li>&ndash;&gt; find k_max (as well as k_max_cmb[ppt-&gt;index_md_tensors], k_max_cl[ppt-&gt;index_md_tensors])</li>
<li>&ndash;&gt; test that result for k_min, k_max make sense</li>
<li>If user asked for k_output_values, add those to all k lists:</li>
<li>&ndash;&gt; Find indices in ppt-&gt;k[index_md] corresponding to 'k_output_values'. We are assuming that ppt-&gt;k is sorted and growing, and we have made sure that ppt-&gt;k_output_values is also sorted and growing.</li>
<li>&ndash;&gt; Decide if we should add k_output_value now. This has to be this complicated, since we can only compare the k-values when both indices are in range.</li>
<li>&ndash;&gt; The two MIN statements are here because in a normal run, the cl and cmb arrays contain a single k value larger than their respective k_max. We are mimicking this behavior.</li>
<li>finally, find the global k_min and k_max for the ensemble of all modes 9scalars, vectors, tensors) </li>
</ul>

</div>
</div>
<a id="a0133b10254da8e7e291758beeb2dbd1a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0133b10254da8e7e291758beeb2dbd1a">&#9670;&nbsp;</a></span>perturb_workspace_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_workspace_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize a <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure. All fields are allocated here, with the exception of the <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> '&ndash;&gt;pv' field, which is allocated separately in perturb_vector_init. We allocate one such <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure per thread and per mode (scalar/../tensor). Then, for each thread, all initial conditions and wavenumbers will use the same workspace.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to the thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">ppw</td><td>Input/Output: pointer to <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure which fields are allocated or filled here </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>Compute maximum l_max for any multipole</li>
<li>Allocate <img class="formulaInl" alt="$ s_l$" src="form_188.png"/>[ ] array for freestreaming of multipoles (see arXiv:1305.3261) and initialize to 1.0, which is the K=0 value.</li>
<li>define indices of metric perturbations obeying constraint equations (this can be done once and for all, because the vector of metric perturbations is the same whatever the approximation scheme, unlike the vector of quantities to be integrated, which is allocated separately in perturb_vector_init)</li>
<li>allocate some workspace in which we will store temporarily the values of background, thermodynamics, metric and source quantities at a given time</li>
<li>count number of approximations, initialize their indices, and allocate their flags</li>
<li>For definiteness, initialize approximation flags to arbitrary values (correct values are overwritten in pertub_find_approximation_switches)</li>
<li>allocate fields where some of the perturbations are stored </li>
</ul>

</div>
</div>
<a id="a22780c266a622dbfd79041206ebfcd2b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22780c266a622dbfd79041206ebfcd2b">&#9670;&nbsp;</a></span>perturb_workspace_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_workspace_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Free the <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure (with the exception of the <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> '&ndash;&gt;pv' field, which is freed separately in perturb_vector_free).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">ppw</td><td>Input: pointer to <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure to be freed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>

</div>
</div>
<a id="afb08128eaf97711c39a1c6b03de9d0c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afb08128eaf97711c39a1c6b03de9d0c1">&#9670;&nbsp;</a></span>perturb_solve()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_solve </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_ic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Solve the perturbation evolution for a given mode, initial condition and wavenumber, and compute the corresponding source functions.</p>
<p>For a given mode, initial condition and wavenumber, this function finds the time ranges over which the perturbations can be described within a given approximation. For each such range, it initializes (or redistributes) perturbations using <a class="el" href="perturbations_8c.html#af24f3c293aed6612641ff4f6bac63994">perturb_vector_init()</a>, and integrates over time. Whenever a "source sampling time" is passed, the source terms are computed and stored in the source table using <a class="el" href="perturbations_8c.html#a846b00583c952e1d772d40e42bd38628">perturb_sources()</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to the thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input/Output: pointer to the perturbation structure (output source functions S(k,tau) written here) </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">index_ic</td><td>Input: index of initial condition under consideration (ad, iso...) </td></tr>
    <tr><td class="paramname">index_k</td><td>Input: index of wavenumber </td></tr>
    <tr><td class="paramname">ppw</td><td>Input: pointer to <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure containing index values and workspaces </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>initialize indices relevant for back/thermo tables search</li>
<li>get wavenumber value</li>
<li>If non-zero curvature, update array of free-streaming coefficients ppw-&gt;s_l</li>
<li>maximum value of tau for which sources are calculated for this wavenumber</li>
<li>using bisection, compute minimum value of tau for which this wavenumber is integrated</li>
<li>find the number of intervals over which approximation scheme is constant</li>
<li>fill the structure containing all fixed parameters, indices and workspaces needed by perturb_derivs</li>
<li>check whether we need to print perturbations to a file for this wavenumber</li>
<li>loop over intervals over which approximation scheme is uniform. For each interval:</li>
<li>&ndash;&gt; (a) fix the approximation scheme</li>
<li>&ndash;&gt; (b) get the previous approximation scheme. If the current interval starts from the initial time tau_ini, the previous approximation is set to be a NULL pointer, so that the function <a class="el" href="perturbations_8c.html#af24f3c293aed6612641ff4f6bac63994">perturb_vector_init()</a> knows that perturbations must be initialized</li>
<li>&ndash;&gt; (c) define the vector of perturbations to be integrated over. If the current interval starts from the initial time tau_ini, fill the vector with initial conditions for each mode. If it starts from an approximation switching point, redistribute correctly the perturbations from the previous to the new vector of perturbations.</li>
<li>&ndash;&gt; (d) integrate the perturbations over the current interval.</li>
<li>if perturbations were printed in a file, close the file</li>
<li>fill the source terms array with zeros for all times between the last integrated time tau_max and tau_today.</li>
<li>free quantities allocated at the beginning of the routine </li>
</ul>

</div>
</div>
<a id="a6030d94fa0132ba4aec2d0c1c8e0c8cc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6030d94fa0132ba4aec2d0c1c8e0c8cc">&#9670;&nbsp;</a></span>perturb_prepare_output()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_prepare_output </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Write titles for all perturbations that we would like to print/store. </p>

</div>
</div>
<a id="ae952f39862d329abce842e5ff0ccef1a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae952f39862d329abce842e5ff0ccef1a">&#9670;&nbsp;</a></span>perturb_find_approximation_number()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_find_approximation_number </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau_ini</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>interval_number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>interval_number_of</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>For a given mode and wavenumber, find the number of intervals of time between tau_ini and tau_end such that the approximation scheme (and the number of perturbation equations) is uniform.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to the thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">k</td><td>Input: index of wavenumber </td></tr>
    <tr><td class="paramname">ppw</td><td>Input: pointer to <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure containing index values and workspaces </td></tr>
    <tr><td class="paramname">tau_ini</td><td>Input: initial time of the perturbation integration </td></tr>
    <tr><td class="paramname">tau_end</td><td>Input: final time of the perturbation integration </td></tr>
    <tr><td class="paramname">interval_number</td><td>Output: total number of intervals </td></tr>
    <tr><td class="paramname">interval_number_of</td><td>Output: number of intervals with respect to each particular approximation </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>fix default number of intervals to one (if no approximation switch)</li>
<li>loop over each approximation and add the number of approximation switching times </li>
</ul>

</div>
</div>
<a id="a32513f12869ecf15659266787513a9d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32513f12869ecf15659266787513a9d6">&#9670;&nbsp;</a></span>perturb_find_approximation_switches()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_find_approximation_switches </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau_ini</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>precision</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>interval_number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>interval_number_of</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>interval_limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>interval_approx</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>For a given mode and wavenumber, find the values of time at which the approximation changes.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to the thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">k</td><td>Input: index of wavenumber </td></tr>
    <tr><td class="paramname">ppw</td><td>Input: pointer to <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure containing index values and workspaces </td></tr>
    <tr><td class="paramname">tau_ini</td><td>Input: initial time of the perturbation integration </td></tr>
    <tr><td class="paramname">tau_end</td><td>Input: final time of the perturbation integration </td></tr>
    <tr><td class="paramname">precision</td><td>Input: tolerance on output values </td></tr>
    <tr><td class="paramname">interval_number</td><td>Input: total number of intervals </td></tr>
    <tr><td class="paramname">interval_number_of</td><td>Input: number of intervals with respect to each particular approximation </td></tr>
    <tr><td class="paramname">interval_limit</td><td>Output: value of time at the boundary of the intervals: tau_ini, tau_switch1, ..., tau_end </td></tr>
    <tr><td class="paramname">interval_approx</td><td>Output: value of approximations in each interval </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>write in output arrays the initial time and approximation</li>
<li>if there are no approximation switches, just write final time and return</li>
<li>if there are switches, consider approximations one after each other. Find switching time by bisection. Store all switches in arbitrary order in array unsorted_tau_switch[ ]</li>
<li>now sort interval limits in correct order</li>
<li>store each approximation in chronological order </li>
</ul>

</div>
</div>
<a id="af24f3c293aed6612641ff4f6bac63994"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af24f3c293aed6612641ff4f6bac63994">&#9670;&nbsp;</a></span>perturb_vector_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_vector_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_ic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>pa_old</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize the field '&ndash;&gt;pv' of a <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> structure, which is a <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure. This structure contains indices and values of all quantities which need to be integrated with respect to time (and only them: quantities fixed analytically or obeying constraint equations are NOT included in this vector). This routine distinguishes between two cases:</p>
<p>&ndash;&gt; the input pa_old is set to the NULL pointer:</p>
<p>This happens when we start integrating over a new wavenumber and we want to set initial conditions for the perturbations. Then, it is assumed that ppw&ndash;&gt;pv is not yet allocated. This routine allocates it, defines all indices, and then fills the vector ppw&ndash;&gt;pv&ndash;&gt;y with the initial conditions defined in perturb_initial_conditions.</p>
<p>&ndash;&gt; the input pa_old is not set to the NULL pointer and describes some set of approximations:</p>
<p>This happens when we need to change approximation scheme while integrating over a given wavenumber. The new approximation described by ppw&ndash;&gt;pa is then different from pa_old. Then, this routine allocates a new vector with a new size and new index values; it fills this vector with initial conditions taken from the previous vector passed as an input in ppw&ndash;&gt;pv, and eventually with some analytic approximations for the new variables appearing at this time; then the new vector comes in replacement of the old one, which is freed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to the thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">index_ic</td><td>Input: index of initial condition under consideration (ad, iso...) </td></tr>
    <tr><td class="paramname">k</td><td>Input: wavenumber </td></tr>
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">ppw</td><td>Input/Output: workspace containing in input the approximation scheme, the background/thermodynamics/metric quantities, and eventually the previous vector y; and in output the new vector y. </td></tr>
    <tr><td class="paramname">pa_old</td><td>Input: NULL is we need to set y to initial conditions for a new wavenumber; points towards a perturb_approximations if we want to switch of approximation. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>allocate a new <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure to which ppw&ndash;&gt;pv will point at the end of the routine</li>
<li>initialize pointers to NULL (they will be allocated later if needed), relevant for <a class="el" href="perturbations_8c.html#a640847cb9e0000f9556404ac7d0a49e8">perturb_vector_free()</a></li>
<li>define all indices in this new vector (depends on approximation scheme, described by the input structure ppw&ndash;&gt;pa)</li>
<li>(a) metric perturbations V or <img class="formulaInl" alt="$ h_v $" src="form_189.png"/> depending on gauge</li>
<li>(b) metric perturbation h is a propagating degree of freedom, so h and hdot are included in the vector of ordinary perturbations, no in that of metric perturbations</li>
<li>allocate vectors for storing the values of all these quantities and their time-derivatives at a given time</li>
<li>specify which perturbations are needed in the evaluation of source terms</li>
<li>case of setting initial conditions for a new wavenumber</li>
<li>&ndash;&gt; (a) check that current approximation scheme is consistent with initial conditions</li>
<li>&ndash;&gt; (b) let ppw&ndash;&gt;pv points towards the <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure that we just created</li>
<li>&ndash;&gt; (c) fill the vector ppw&ndash;&gt;pv&ndash;&gt;y with appropriate initial conditions</li>
<li>case of switching approximation while a wavenumber is being integrated</li>
<li>&ndash;&gt; (a) for the scalar mode:</li>
<li>&mdash;&gt; (a.1.) check that the change of approximation scheme makes sense (note: before calling this routine there is already a check that we wish to change only one approximation flag at a time)</li>
<li>&mdash;&gt; (a.2.) some variables (b, cdm, fld, ...) are not affected by any approximation. They need to be reconducted whatever the approximation switching is. We treat them here. Below we will treat other variables case by case.</li>
<li>&ndash;&gt; (b) for the vector mode</li>
<li>&mdash;&gt; (b.1.) check that the change of approximation scheme makes sense (note: before calling this routine there is already a check that we wish to change only one approximation flag at a time)</li>
<li>&mdash;&gt; (b.2.) some variables (gw, gwdot, ...) are not affected by any approximation. They need to be reconducted whatever the approximation switching is. We treat them here. Below we will treat other variables case by case.</li>
<li>&ndash;&gt; (c) for the tensor mode</li>
<li>&mdash;&gt; (c.1.) check that the change of approximation scheme makes sense (note: before calling this routine there is already a check that we wish to change only one approximation flag at a time)</li>
<li>&mdash;&gt; (c.2.) some variables (gw, gwdot, ...) are not affected by any approximation. They need to be reconducted whatever the approximation switching is. We treat them here. Below we will treat other variables case by case.</li>
<li>&ndash;&gt; (d) free the previous vector of perturbations</li>
<li>&ndash;&gt; (e) let ppw&ndash;&gt;pv points towards the <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure that we just created </li>
</ul>

</div>
</div>
<a id="a640847cb9e0000f9556404ac7d0a49e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a640847cb9e0000f9556404ac7d0a49e8">&#9670;&nbsp;</a></span>perturb_vector_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_vector_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> *&#160;</td>
          <td class="paramname"><em>pv</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Free the <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pv</td><td>Input: pointer to <a class="el" href="perturbations_8h.html#structperturb__vector">perturb_vector</a> structure to be freed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>

</div>
</div>
<a id="a32fef60bdb0627ff3982d1d8185aa566"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32fef60bdb0627ff3982d1d8185aa566">&#9670;&nbsp;</a></span>perturb_initial_conditions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_initial_conditions </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_ic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>For each mode, wavenumber and initial condition, this function initializes in the vector all values of perturbed variables (in a given gauge). It is assumed here that all values have previously been set to zero, only non-zero values are set here.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">index_ic</td><td>Input: index of initial condition under consideration (ad, iso...) </td></tr>
    <tr><td class="paramname">k</td><td>Input: wavenumber </td></tr>
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">ppw</td><td>Input/Output: workspace containing in input the approximation scheme, the background/thermodynamics/metric quantities, and eventually the previous vector y; and in output the new vector y. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<p>&ndash;&gt; Declare local variables</p>
<p>&ndash;&gt; For scalars</p>
<ul>
<li>(a) compute relevant background quantities: compute rho_r, rho_m, rho_nu (= all relativistic except photons), and their ratio.</li>
<li>(b) starts by setting everything in synchronous gauge. If another gauge is needed, we will perform a gauge transformation below.</li>
<li>&ndash;&gt; (b.1.) adiabatic</li>
<li>&mdash;&gt; Canonical field (solving for the perturbations): initial perturbations set to zero, they should reach the attractor soon enough.</li>
<li>&mdash;&gt; TODO: Incorporate the attractor IC from 1004.5509. delta_phi <img class="formulaInl" alt="$ = -(a/k)^2/\phi'(\rho + p)\theta $" src="form_190.png"/>, delta_phi_prime <img class="formulaInl" alt="$ = a^2/\phi' $" src="form_191.png"/> (delta_rho_phi + V'delta_phi), and assume theta, delta_rho as for perfect fluid with <img class="formulaInl" alt="$ c_s^2 = 1 $" src="form_192.png"/> and w = 1/3 (ASSUMES radiation TRACKING)</li>
<li>&ndash;&gt; (b.2.) Cold dark matter Isocurvature</li>
<li>&ndash;&gt; (b.3.) Baryon Isocurvature</li>
<li>&ndash;&gt; (b.4.) Neutrino density Isocurvature</li>
<li>&ndash;&gt; (b.5.) Neutrino velocity Isocurvature</li>
<li>(c) If the needed gauge is really the synchronous gauge, we need to affect the previously computed value of eta to the actual variable eta</li>
<li>(d) If the needed gauge is the newtonian gauge, we must compute alpha and then perform a gauge transformation for each variable</li>
<li>(e) In any gauge, we should now implement the relativistic initial conditions in ur and ncdm variables</li>
</ul>
<p>&ndash;&gt; For tensors</p>
<p>tensor initial conditions take into account the fact that scalar (resp. tensor) <img class="formulaInl" alt="$ C_l$" src="form_66.png"/>'s are related to the real space power spectrum of curvature (resp. of the tensor part of metric perturbations)</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ &lt;R(x) R(x)&gt; \ \ \sum_{ij} &lt;h_{ij}(x) h^{ij}(x)&gt; \]" src="form_193.png"/>
</p>
<p>In momentum space it is conventional to use the modes R(k) and h(k) where the quantity h obeying to the equation of propagation:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ h'' + \frac{2a'}{a} h + [k2+2K] h = 12\pi Ga2 (\rho+p) \sigma = 8\pi Ga2 p \pi \]" src="form_194.png"/>
</p>
<p>and the power spectra in real space and momentum space are related through:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ &lt;R(x) R(x)&gt; = \int \frac{dk}{k} \left[ \frac{k^3}{2\pi^2} &lt;R(k)R(k)^*&gt;\right] = \int \frac{dk}{k} \mathcal{P}_R(k) \]" src="form_195.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[\sum_{ij} &lt;h_{ij}(x) h^{ij}(x)&gt; = \frac{dk}{k} \left[ \frac{k^3}{2\pi^2} F\left(\frac{k^2}{K}\right) &lt;h(k)h(k)^*&gt;\right] = \int \frac{dk}{k} F\left(\frac{k^2}{K}\right) \mathcal{P}_h(k) \]" src="form_196.png"/>
</p>
<p>where <img class="formulaInl" alt="$ \mathcal{P}_R$" src="form_197.png"/> and <img class="formulaInl" alt="$ \mathcal{P}_h$" src="form_198.png"/> are the dimensionless spectrum of curvature R, and F is a function of k2/K, where K is the curvature parameter. F is equal to one in flat space (K=0), and coming from the contraction of the laplacian eigentensor <img class="formulaInl" alt="$ Q_{ij}$" src="form_199.png"/> with itself. We will give F explicitly below.</p>
<p>Similarly the scalar (S) and tensor (T) <img class="formulaInl" alt="$ C_l$" src="form_66.png"/>'s are given by</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ C_l^S = 4\pi \int \frac{dk}{k} [\Delta_l^S(q)]^2 \mathcal{P}_R(k) \]" src="form_200.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ C_l^T = 4\pi \int \frac{dk}{k} [\Delta_l^T(q)]^2 F\left(\frac{k^2}{K}\right) \mathcal{P}_h(k) \]" src="form_201.png"/>
</p>
<p>The usual convention for the tensor-to-scalar ratio <img class="formulaInl" alt="$ r = A_t / A_s $" src="form_202.png"/> at pivot scale = 16 epsilon in single-field inflation is such that for constant <img class="formulaInl" alt="$ \mathcal{P}_R(k)$" src="form_203.png"/> and <img class="formulaInl" alt="$ \mathcal{P}_h(k)$" src="form_204.png"/>,</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ r = 6 \frac{\mathcal{P}_h(k)}{\mathcal{P}_R(k)} \]" src="form_205.png"/>
</p>
<p>so</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathcal{P}_h(k) = \frac{\mathcal{P}_R(k) r}{6} = \frac{A_s r}{6} = \frac{A_t}{6} \]" src="form_206.png"/>
</p>
<p>A priori it would make sense to say that for a power-law primordial spectrum there is an extra factor <img class="formulaInl" alt="$ (k/k_{pivot})^{n_t} $" src="form_207.png"/> (and eventually running and so on and so forth...)</p>
<p>However it has been shown that the minimal models of inflation in a negatively curved bubble lead to <img class="formulaInl" alt="$ \mathcal{P}_h(k)=\tanh(\pi*\nu/2)$" src="form_208.png"/>. In open models it is customary to define the tensor tilt in a non-flat universe as a deviation from this behavior rather than from true scale-invariance in the above sense.</p>
<p>Hence we should have</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathcal{P}_h(k) = \frac{A_t}{6} [ \tanh(\pi*\frac{\nu}{2})] (k/k_{pivot})^{(n_t+...)}\]" src="form_209.png"/>
</p>
<p>where the brackets </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ [...] \]" src="form_210.png"/>
</p>
<p> mean "if K&lt;0"</p>
<p>Then</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ C_l^T = 4\pi \int \frac{dk}{k} [\Delta_l^T(q)]^2 F\left(\frac{k^2}{K}\right) \frac{A_t}{6} [\tanh(\pi*\frac{\nu}{2})] (k/k_{pivot})^{(n_t+...)} \]" src="form_211.png"/>
</p>
<p>In the code, it is then a matter of choice to write:</p>
<ul>
<li>In the primordial module: <img class="formulaInl" alt="$ \mathcal{P}_h(k) = \frac{A_t}{6} \tanh{(\pi*\frac{\nu}{2})} (k/k^*)^{n_T}$" src="form_212.png"/></li>
<li>In the perturbation initial conditions: <img class="formulaInl" alt="$ h = 1$" src="form_213.png"/></li>
<li>In the spectra module: <img class="formulaInl" alt="$ C_l^T = \frac{4}{\pi} \int \frac{dk}{k} [\Delta_l^T(q)]^2 F\left(\frac{k^2}{K}\right) \mathcal{P}_h(k) $" src="form_214.png"/></li>
</ul>
<p>or:</p>
<ul>
<li>In the primordial module: <img class="formulaInl" alt="$ \mathcal{P}_h(k) = A_t (k/k^*)^{n_T} $" src="form_215.png"/></li>
<li>In the perturbation initial conditions: <img class="formulaInl" alt="$ h = \sqrt{[F\left(\frac{k^2}{K}\right) / 6] \tanh{(\pi*\frac{\nu}{2})}} $" src="form_216.png"/></li>
<li>In the spectra module: <img class="formulaInl" alt="$ C_l^T = \frac{4}{\pi} \int \frac{dk}{k} [\Delta_l^T(q)]^2 \mathcal{P}_h(k) $" src="form_217.png"/></li>
</ul>
<p>We choose this last option, such that the primordial and spectra module differ minimally in flat and non-flat space. Then we must impose</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ h = \sqrt{\left(\frac{F}{6}\right) \tanh{(\pi*\frac{\nu}{2})}} \]" src="form_218.png"/>
</p>
<p>The factor F is found to be given by:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{ij}&lt;h_{ij}(x) h^{ij}(x)&gt; = \int \frac{dk}{k} \frac{k2(k2-K)}{(k2+3K)(k2+2K)} \mathcal{P}_h(k) \]" src="form_219.png"/>
</p>
<p>Introducing as usual <img class="formulaInl" alt="$ q2 = k2 - 3K $" src="form_220.png"/> and using qdq = kdk this gives</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{ij}&lt;h_{ij}(x) h^{ij}(x)&gt; = \int \frac{dk}{k} \frac{(q2-3K)(q2-4K)}{q2(q2-K)} \mathcal{P}_h(k) \]" src="form_221.png"/>
</p>
<p>Using qdq = kdk this is equivalent to</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{ij}&lt;h_{ij}(x) h^{ij}(x)&gt; = \int \frac{dq}{q} \frac{q2-4K}{q2-K} \mathcal{P}_h(k(q)) \]" src="form_222.png"/>
</p>
<p>Finally, introducing <img class="formulaInl" alt="$ \nu=q/\sqrt{|K|}$" src="form_223.png"/> and sgnK=SIGN(k) <img class="formulaInl" alt="$=\pm 1$" src="form_224.png"/>, this could also be written</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{ij}&lt;h_{ij}(x) h^{ij}(x)&gt; = \int \frac{d\nu}{\nu} \frac{(\nu2-4sgnK)}{(\nu2-sgnK)} \mathcal{P}_h(k(\nu)) \]" src="form_225.png"/>
</p>
<p>Equation (43,44) of Hu, Seljak, White, Zaldarriaga is equivalent to absorbing the above factor <img class="formulaInl" alt="$ (\nu2-4sgnK)/(\nu2-sgnK)$" src="form_226.png"/> in the definition of the primordial spectrum. Since the initial condition should be written in terms of k rather than nu, they should read</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ h = \sqrt{ [k2(k2-K)]/[(k2+3K)(k2+2K)] / 6 * \tanh{(\pi*\frac{\nu}{2})} } \]" src="form_227.png"/>
</p>
<p>We leave the freedom to multiply by an arbitrary number ppr-&gt;gw_ini. The standard convention corresponding to standard definitions of r, <img class="formulaInl" alt="$ A_T$" src="form_228.png"/>, <img class="formulaInl" alt="$ n_T$" src="form_229.png"/> is however ppr-&gt;gw_ini=1.</p>

</div>
</div>
<a id="adc944c8e172833c9c18557e1508b828a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adc944c8e172833c9c18557e1508b828a">&#9670;&nbsp;</a></span>perturb_approximations()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_approximations </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Evaluate background/thermodynamics at <img class="formulaInl" alt="$ \tau $" src="form_43.png"/>, infer useful flags / time scales for integrating perturbations.</p>
<p>Evaluate background quantities at <img class="formulaInl" alt="$ \tau $" src="form_43.png"/>, as well as thermodynamics for scalar mode; infer useful flags and time scales for integrating the perturbations:</p><ul>
<li>check whether tight-coupling approximation is needed.</li>
<li>check whether radiation (photons, massless neutrinos...) perturbations are needed.</li>
<li>choose step of integration: step = ppr-&gt;perturb_integration_stepsize * min_time_scale, where min_time_scale = smallest time scale involved in the equations. There are three time scales to compare:<ol type="1">
<li>that of recombination, <img class="formulaInl" alt="$ \tau_c = 1/\kappa' $" src="form_230.png"/></li>
<li>Hubble time scale, <img class="formulaInl" alt="$ \tau_h = a/a' $" src="form_231.png"/></li>
<li>Fourier mode, <img class="formulaInl" alt="$ \tau_k = 1/k $" src="form_232.png"/></li>
</ol>
</li>
</ul>
<p>So, in general, min_time_scale = <img class="formulaInl" alt="$ \min(\tau_c, \tau_b, \tau_h, \tau_k) $" src="form_233.png"/>.</p>
<p>However, if <img class="formulaInl" alt="$ \tau_c \ll \tau_h $" src="form_234.png"/> and <img class="formulaInl" alt="$ \tau_c \ll \tau_k $" src="form_235.png"/>, we can use the tight-coupling regime for photons and write equations in such way that the time scale <img class="formulaInl" alt="$ \tau_c $" src="form_236.png"/> becomes irrelevant (no effective mass term in <img class="formulaInl" alt="$ 1/\tau_c $" src="form_237.png"/>). Then, the smallest scale in the equations is only <img class="formulaInl" alt="$ \min(\tau_h, \tau_k) $" src="form_238.png"/>. In practise, it is sufficient to use only the condition <img class="formulaInl" alt="$ \tau_c \ll \tau_h $" src="form_234.png"/>.</p>
<p>Also, if <img class="formulaInl" alt="$ \rho_{matter} \gg \rho_{radiation} $" src="form_239.png"/> and <img class="formulaInl" alt="$ k \gg aH $" src="form_240.png"/>, we can switch off radiation perturbations (i.e. switch on the free-streaming approximation) and then the smallest scale is simply <img class="formulaInl" alt="$ \tau_h $" src="form_241.png"/>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">k</td><td>Input: wavenumber </td></tr>
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">ppw</td><td>Input/Output: in output contains the approximation to be used at this time </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>compute Fourier mode time scale = <img class="formulaInl" alt="$ \tau_k = 1/k $" src="form_232.png"/></li>
<li>evaluate background quantities with <a class="el" href="background_8c.html#ac47004414b208d36153f35d8465cace2">background_at_tau()</a> and Hubble time scale <img class="formulaInl" alt="$ \tau_h = a/a' $" src="form_231.png"/></li>
<li>for scalar modes:</li>
<li>&ndash;&gt; (a) evaluate thermodynamical quantities with <a class="el" href="thermodynamics_8c.html#a5763e8991ba30efe92c3007d1abfee95">thermodynamics_at_z()</a></li>
<li>&mdash;&gt; (b.1.) if <img class="formulaInl" alt="$ \kappa'=0 $" src="form_242.png"/>, recombination is finished; tight-coupling approximation must be off</li>
<li>&mdash;&gt; (b.2.) if <img class="formulaInl" alt="$ \kappa' \neq 0 $" src="form_243.png"/>, recombination is not finished: check tight-coupling approximation</li>
<li>-&mdash;&gt; (b.2.a) compute recombination time scale for photons, <img class="formulaInl" alt="$ \tau_{\gamma} = 1/ \kappa' $" src="form_244.png"/></li>
<li>-&mdash;&gt; (b.2.b) check whether tight-coupling approximation should be on</li>
<li>&ndash;&gt; (c) free-streaming approximations</li>
<li>for tensor modes:</li>
<li>&ndash;&gt; (a) evaluate thermodynamical quantities with <a class="el" href="thermodynamics_8c.html#a5763e8991ba30efe92c3007d1abfee95">thermodynamics_at_z()</a></li>
<li>&mdash;&gt; (b.1.) if <img class="formulaInl" alt="$ \kappa'=0 $" src="form_242.png"/>, recombination is finished; tight-coupling approximation must be off</li>
<li>&mdash;&gt; (b.2.) if <img class="formulaInl" alt="$ \kappa' \neq 0 $" src="form_243.png"/>, recombination is not finished: check tight-coupling approximation</li>
<li>-&mdash;&gt; (b.2.a) compute recombination time scale for photons, <img class="formulaInl" alt="$ \tau_{\gamma} = 1/ \kappa' $" src="form_244.png"/></li>
<li>-&mdash;&gt; (b.2.b) check whether tight-coupling approximation should be on </li>
</ul>

</div>
</div>
<a id="ac25f59a7fd0f4f7eb58c5c2c4620eac6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac25f59a7fd0f4f7eb58c5c2c4620eac6">&#9670;&nbsp;</a></span>perturb_timescale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_timescale </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>parameters_and_workspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>timescale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ErrorMsg&#160;</td>
          <td class="paramname"><em>error_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Compute typical timescale over which the perturbation equations vary. Some integrators (e.g. Runge-Kunta) benefit from calling this routine at each step in order to adapt the next step.</p>
<p>This is one of the few functions in the code which is passed to the generic_integrator() routine. Since generic_integrator() should work with functions passed from various modules, the format of the arguments is a bit special:</p><ul>
<li>fixed parameters and workspaces are passed through a generic pointer. generic_integrator() doesn't know the content of this pointer.</li>
<li>the error management is a bit special: errors are not written as usual to pth-&gt;error_message, but to a generic error_message passed in the list of arguments.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">parameters_and_workspace</td><td>Input: fixed parameters (e.g. indices), workspace, approximation used, etc. </td></tr>
    <tr><td class="paramname">timescale</td><td>Output: perturbation variation timescale (given the approximation used) </td></tr>
    <tr><td class="paramname">error_message</td><td>Output: error message </td></tr>
  </table>
  </dd>
</dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>extract the fields of the parameter_and_workspace input structure</li>
<li>compute Fourier mode time scale = <img class="formulaInl" alt="$ \tau_k = 1/k $" src="form_232.png"/></li>
<li>evaluate background quantities with <a class="el" href="background_8c.html#ac47004414b208d36153f35d8465cace2">background_at_tau()</a> and Hubble time scale <img class="formulaInl" alt="$ \tau_h = a/a' $" src="form_231.png"/></li>
<li>for scalars modes:</li>
<li>&ndash;&gt; compute recombination time scale for photons, <img class="formulaInl" alt="$ \tau_{\gamma} = 1/ \kappa' $" src="form_244.png"/></li>
<li>for vector modes:</li>
<li>&ndash;&gt; compute recombination time scale for photons, <img class="formulaInl" alt="$ \tau_{\gamma} = 1/ \kappa' $" src="form_244.png"/></li>
<li>for tensor modes:</li>
<li>&ndash;&gt; compute recombination time scale for photons, <img class="formulaInl" alt="$ \tau_{\gamma} = 1/ \kappa' $" src="form_244.png"/> </li>
</ul>

</div>
</div>
<a id="ac3d9fb29d84566ab67c69ee8d28a30c4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac3d9fb29d84566ab67c69ee8d28a30c4">&#9670;&nbsp;</a></span>perturb_einstein()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_einstein </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Compute metric perturbations (those not integrated over time) using Einstein equations</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ppr</td><td>Input: pointer to precision structure </td></tr>
    <tr><td class="paramname">pba</td><td>Input: pointer to background structure </td></tr>
    <tr><td class="paramname">pth</td><td>Input: pointer to thermodynamics structure </td></tr>
    <tr><td class="paramname">ppt</td><td>Input: pointer to the perturbation structure </td></tr>
    <tr><td class="paramname">index_md</td><td>Input: index of mode under consideration (scalar/.../tensor) </td></tr>
    <tr><td class="paramname">k</td><td>Input: wavenumber </td></tr>
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">y</td><td>Input: vector of perturbations (those integrated over time) (already allocated) </td></tr>
    <tr><td class="paramname">ppw</td><td>Input/Output: in output contains the updated metric perturbations </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>define wavenumber and scale factor related quantities</li>
<li>sum up perturbations from all species</li>
<li>for scalar modes:</li>
<li>&ndash;&gt; infer metric perturbations from Einstein equations</li>
<li>for vector modes</li>
<li>for tensor modes </li>
</ul>

</div>
</div>
<a id="a11f17fb88c32d9cadae8b74efac77b01"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a11f17fb88c32d9cadae8b74efac77b01">&#9670;&nbsp;</a></span>perturb_total_stress_energy()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_total_stress_energy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="common_8h.html#structprecision">precision</a> *&#160;</td>
          <td class="paramname"><em>ppr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="background_8h.html#structbackground">background</a> *&#160;</td>
          <td class="paramname"><em>pba</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="thermodynamics_8h.html#structthermo">thermo</a> *&#160;</td>
          <td class="paramname"><em>pth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturbs">perturbs</a> *&#160;</td>
          <td class="paramname"><em>ppt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="perturbations_8h.html#structperturb__workspace">perturb_workspace</a> *&#160;</td>
          <td class="paramname"><em>ppw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>wavenumber and scale factor related quantities</li>
<li>for scalar modes</li>
<li>&ndash;&gt; (a) deal with approximation schemes</li>
<li>&mdash;&gt; (a.1.) photons</li>
<li>-&mdash;&gt; (a.1.1.) no approximation</li>
<li>-&mdash;&gt; (a.1.2.) radiation streaming approximation</li>
<li>-&mdash;&gt; (a.1.3.) tight coupling approximation</li>
<li>&mdash;&gt; (a.2.) ur</li>
<li>&ndash;&gt; (b) compute the total density, velocity and shear perturbations</li>
<li>for vector modes</li>
<li>&ndash;&gt; photon contribution to vector sources:</li>
<li>&ndash;&gt; baryons</li>
<li>for tensor modes</li>
<li>&ndash;&gt; photon contribution to gravitational wave source:</li>
<li>&ndash;&gt; ur contribution to gravitational wave source:</li>
<li>&ndash;&gt; ncdm contribution to gravitational wave source: </li>
</ul>

</div>
</div>
<a id="a846b00583c952e1d772d40e42bd38628"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a846b00583c952e1d772d40e42bd38628">&#9670;&nbsp;</a></span>perturb_sources()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_sources </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index_tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>parameters_and_workspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ErrorMsg&#160;</td>
          <td class="paramname"><em>error_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Compute the source functions (three terms for temperature, one for E or B modes, etc.)</p>
<p>This is one of the few functions in the code which is passed to the generic_integrator() routine. Since generic_integrator() should work with functions passed from various modules, the format of the arguments is a bit special:</p>
<ul>
<li>fixed parameters and workspaces are passed through a generic pointer. generic_integrator() doesn't know the content of this pointer.</li>
<li>the error management is a bit special: errors are not written as usual to pth-&gt;error_message, but to a generic error_message passed in the list of arguments.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">y</td><td>Input: vector of perturbations </td></tr>
    <tr><td class="paramname">dy</td><td>Input: vector of time derivative of perturbations </td></tr>
    <tr><td class="paramname">index_tau</td><td>Input: index in the array tau_sampling </td></tr>
    <tr><td class="paramname">parameters_and_workspace</td><td>Input/Output: in input, all parameters needed by perturb_derivs, in output, source terms </td></tr>
    <tr><td class="paramname">error_message</td><td>Output: error message </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the error status </dd></dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>rename structure fields (just to avoid heavy notations)</li>
<li>get background/thermo quantities in this point</li>
<li>for scalars</li>
<li>&ndash;&gt; compute metric perturbations</li>
<li>&ndash;&gt; compute quantities depending on approximation schemes</li>
<li>&ndash;&gt; for each type, compute source terms</li>
<li>for tensors</li>
<li>&ndash;&gt; compute quantities depending on approximation schemes </li>
</ul>

</div>
</div>
<a id="a7102d2605e166f2f2eaf5518aeab79fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7102d2605e166f2f2eaf5518aeab79fc">&#9670;&nbsp;</a></span>perturb_print_variables()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_print_variables </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>parameters_and_workspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ErrorMsg&#160;</td>
          <td class="paramname"><em>error_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>When testing the code or a cosmological model, it can be useful to output perturbations at each step of integration (and not just the delta's at each source sampling point, which is achieved simply by asking for matter transfer functions). Then this function can be passed to the generic_evolver routine.</p>
<p>By default, instead of passing this function to generic_evolver, one passes a null pointer. Then this function is just not used.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">y</td><td>Input: vector of perturbations </td></tr>
    <tr><td class="paramname">dy</td><td>Input: vector of its derivatives (already allocated) </td></tr>
    <tr><td class="paramname">parameters_and_workspace</td><td>Input: fixed parameters (e.g. indices) </td></tr>
    <tr><td class="paramname">error_message</td><td>Output: error message </td></tr>
  </table>
  </dd>
</dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>ncdm sector begins</li>
<li>ncdm sector ends</li>
<li>rename structure fields (just to avoid heavy notations)</li>
<li>update background/thermo quantities in this point</li>
<li>update metric perturbations in this point</li>
<li>calculate perturbed recombination</li>
<li>for scalar modes</li>
<li>&ndash;&gt; Get delta, deltaP/rho, theta, shear and store in array</li>
<li>&ndash;&gt; Do gauge transformation of delta, deltaP/rho (?) and theta using -= 3aH(1+w_ncdm) alpha for delta.</li>
<li>&ndash;&gt; Handle (re-)allocation</li>
<li>for tensor modes:</li>
<li>&ndash;&gt; Handle (re-)allocation </li>
</ul>

</div>
</div>
<a id="aa6f273487c3cc276a4db995051e850c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa6f273487c3cc276a4db995051e850c1">&#9670;&nbsp;</a></span>perturb_derivs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_derivs </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>parameters_and_workspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ErrorMsg&#160;</td>
          <td class="paramname"><em>error_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Compute derivative of all perturbations to be integrated</p>
<p>For each mode (scalar/vector/tensor) and each wavenumber k, this function computes the derivative of all values in the vector of perturbed variables to be integrated.</p>
<p>This is one of the few functions in the code which is passed to the generic_integrator() routine. Since generic_integrator() should work with functions passed from various modules, the format of the arguments is a bit special:</p><ul>
<li>fixed parameters and workspaces are passed through a generic pointer. generic_integrator() doesn't know what the content of this pointer is.</li>
<li>errors are not written as usual in pth-&gt;error_message, but in a generic error_message passed in the list of arguments.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tau</td><td>Input: conformal time </td></tr>
    <tr><td class="paramname">y</td><td>Input: vector of perturbations </td></tr>
    <tr><td class="paramname">dy</td><td>Output: vector of its derivatives (already allocated) </td></tr>
    <tr><td class="paramname">parameters_and_workspace</td><td>Input/Output: in input, fixed parameters (e.g. indices); in output, background and thermo quantities evaluated at tau. </td></tr>
    <tr><td class="paramname">error_message</td><td>Output: error message </td></tr>
  </table>
  </dd>
</dl>
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>rename the fields of the input structure (just to avoid heavy notations)</li>
<li>get background/thermo quantities in this point</li>
<li>get metric perturbations with <a class="el" href="perturbations_8c.html#ac3d9fb29d84566ab67c69ee8d28a30c4">perturb_einstein()</a></li>
<li>compute related background quantities</li>
<li>Compute 'generalised cotK function of argument <img class="formulaInl" alt="$ \sqrt{|K|}*\tau $" src="form_245.png"/>, for closing hierarchy. (see equation 2.34 in arXiv:1305.3261):</li>
<li>for scalar modes:</li>
<li>&ndash;&gt; (a) define short-cut notations for the scalar perturbations</li>
<li>&ndash;&gt; (b) perturbed recombination</li>
<li>&ndash;&gt; (c) compute metric-related quantities (depending on gauge; additional gauges can be coded below)<ul>
<li>Each continuity equation contains a term in (theta+metric_continuity) with metric_continuity = (h_prime/2) in synchronous gauge, (-3 phi_prime) in newtonian gauge</li>
<li>Each Euler equation contains a source term metric_euler with metric_euler = 0 in synchronous gauge, (k2 psi) in newtonian gauge</li>
<li>Each shear derivative equation contains a source term metric_shear equal to metric_shear = (h_prime+6eta_prime)/2 in synchronous gauge, 0 in newtonian gauge</li>
<li>metric_shear_prime is the derivative of metric_shear</li>
<li>In the ufa_class approximation, the leading-order source term is (h_prime/2) in synchronous gauge, (-3 (phi_prime+psi_prime)) in newtonian gauge: we approximate the later by (-6 phi_prime)</li>
</ul>
</li>
<li>&ndash;&gt; (d) if some approximation schemes are turned on, enforce a few y[] values computed in perturb_einstein</li>
<li>&ndash;&gt; (e) BEGINNING OF ACTUAL SYSTEM OF EQUATIONS OF EVOLUTION</li>
<li>&mdash;&gt; photon temperature density</li>
<li>&mdash;&gt; baryon density</li>
<li>&mdash;&gt; baryon velocity (depends on tight-coupling approximation=tca)</li>
<li>-&mdash;&gt; perturbed recombination has an impact</li>
<li>&mdash;&gt; photon temperature higher momenta and photon polarization (depend on tight-coupling approximation)</li>
<li>-&mdash;&gt; if photon tight-coupling is off</li>
<li>&ndash;&mdash;&gt; define <img class="formulaInl" alt="$ \Pi = G_{\gamma 0} + G_{\gamma 2} + F_{\gamma 2} $" src="form_246.png"/></li>
<li>&ndash;&mdash;&gt; photon temperature velocity</li>
<li>&ndash;&mdash;&gt; photon temperature shear</li>
<li>&ndash;&mdash;&gt; photon temperature l=3</li>
<li>&ndash;&mdash;&gt; photon temperature l&gt;3</li>
<li>&ndash;&mdash;&gt; photon temperature lmax</li>
<li>&ndash;&mdash;&gt; photon polarization l=0</li>
<li>&ndash;&mdash;&gt; photon polarization l=1</li>
<li>&ndash;&mdash;&gt; photon polarization l=2</li>
<li>&ndash;&mdash;&gt; photon polarization l&gt;2</li>
<li>&ndash;&mdash;&gt; photon polarization lmax_pol</li>
<li>-&mdash;&gt; if photon tight-coupling is on:</li>
<li>&ndash;&mdash;&gt; in that case, only need photon velocity</li>
<li>&mdash;&gt; cdm</li>
<li>-&mdash;&gt; newtonian gauge: cdm density and velocity</li>
<li>-&mdash;&gt; synchronous gauge: cdm density only (velocity set to zero by definition of the gauge)</li>
<li>&mdash;&gt; dcdm and dr</li>
<li>-&mdash;&gt; dcdm</li>
<li>&mdash;&gt; dr</li>
<li>-&mdash;&gt; dr F0</li>
<li>-&mdash;&gt; dr F1</li>
<li>-&mdash;&gt; exact dr F2</li>
<li>-&mdash;&gt; exact dr l=3</li>
<li>-&mdash;&gt; exact dr l&gt;3</li>
<li>-&mdash;&gt; exact dr lmax_dr</li>
<li>&mdash;&gt; fluid (fld)</li>
<li>-&mdash;&gt; factors w, w_prime, adiabatic sound speed ca2 (all three background-related), plus actual sound speed in the fluid rest frame cs2</li>
<li>-&mdash;&gt; fluid density</li>
<li>-&mdash;&gt; fluid velocity</li>
<li>&mdash;&gt; scalar field (scf)</li>
<li>-&mdash;&gt; field value</li>
<li>-&mdash;&gt; Klein Gordon equation</li>
<li>&mdash;&gt; ultra-relativistic neutrino/relics (ur)</li>
<li>-&mdash;&gt; if radiation streaming approximation is off</li>
<li>&ndash;&mdash;&gt; ur density</li>
<li>&ndash;&mdash;&gt; ur velocity</li>
<li>&ndash;&mdash;&gt; exact ur shear</li>
<li>&ndash;&mdash;&gt; exact ur l=3</li>
<li>&ndash;&mdash;&gt; exact ur l&gt;3</li>
<li>&ndash;&mdash;&gt; exact ur lmax_ur</li>
<li>&ndash;&mdash;&gt; in fluid approximation (ufa): only ur shear needed</li>
<li>&mdash;&gt; non-cold dark matter (ncdm): massive neutrinos, WDM, etc.</li>
<li>-&mdash;&gt; first case: use a fluid approximation (ncdmfa)</li>
<li>&ndash;&mdash;&gt; loop over species</li>
<li>&ndash;&mdash;&gt; define intermediate quantitites</li>
<li>&ndash;&mdash;&gt; exact continuity equation</li>
<li>&ndash;&mdash;&gt; exact euler equation</li>
<li>&ndash;&mdash;&gt; different ansatz for approximate shear derivative</li>
<li>&ndash;&mdash;&gt; jump to next species</li>
<li>-&mdash;&gt; second case: use exact equation (Boltzmann hierarchy on momentum grid)</li>
<li>&ndash;&mdash;&gt; loop over species</li>
<li>&ndash;&mdash;&gt; loop over momentum</li>
<li>&ndash;&mdash;&gt; define intermediate quantities</li>
<li>&ndash;&mdash;&gt; ncdm density for given momentum bin</li>
<li>&ndash;&mdash;&gt; ncdm velocity for given momentum bin</li>
<li>&ndash;&mdash;&gt; ncdm shear for given momentum bin</li>
<li>&ndash;&mdash;&gt; ncdm l&gt;3 for given momentum bin</li>
<li>&ndash;&mdash;&gt; ncdm lmax for given momentum bin (truncation as in Ma and Bertschinger) but with curvature taken into account a la arXiv:1305.3261</li>
<li>&ndash;&mdash;&gt; jump to next momentum bin or species</li>
<li>&mdash;&gt; metric</li>
<li>&mdash;&gt; eta of synchronous gauge</li>
<li>vector mode</li>
<li>&ndash;&gt; baryon velocity</li>
<li>tensor modes:</li>
<li>&ndash;&gt; non-cold dark matter (ncdm): massive neutrinos, WDM, etc.</li>
<li>&mdash;&gt; loop over species</li>
<li>-&mdash;&gt; loop over momentum</li>
<li>-&mdash;&gt; define intermediate quantities</li>
<li>-&mdash;&gt; ncdm density for given momentum bin</li>
<li>-&mdash;&gt; ncdm l&gt;0 for given momentum bin</li>
<li>-&mdash;&gt; ncdm lmax for given momentum bin (truncation as in Ma and Bertschinger) but with curvature taken into account a la arXiv:1305.3261</li>
<li>-&mdash;&gt; jump to next momentum bin or species</li>
<li>&ndash;&gt; tensor metric perturbation h (gravitational waves)</li>
<li>&ndash;&gt; its time-derivative </li>
</ul>

</div>
</div>
<a id="a2767b1841cc9aab30957347853d8db6d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2767b1841cc9aab30957347853d8db6d">&#9670;&nbsp;</a></span>perturb_tca_slip_and_shear()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int perturb_tca_slip_and_shear </td>
          <td>(</td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>parameters_and_workspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ErrorMsg&#160;</td>
          <td class="paramname"><em>error_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Summary:</p>
<ul>
<li>define local variables</li>
<li>rename the fields of the input structure (just to avoid heavy notations)</li>
<li>compute related background quantities</li>
<li>&ndash;&gt; (a) define short-cut notations for the scalar perturbations</li>
<li>&ndash;&gt; (b) define short-cut notations used only in tight-coupling approximation</li>
<li>&ndash;&gt; (c) compute metric-related quantities (depending on gauge; additional gauges can be coded below)<ul>
<li>Each continuity equation contains a term in (theta+metric_continuity) with metric_continuity = (h_prime/2) in synchronous gauge, (-3 phi_prime) in newtonian gauge</li>
<li>Each Euler equation contains a source term metric_euler with metric_euler = 0 in synchronous gauge, (k2 psi) in newtonian gauge</li>
<li>Each shear derivative equation contains a source term metric_shear equal to metric_shear = (h_prime+6eta_prime)/2 in synchronous gauge, 0 in newtonian gauge</li>
<li>metric_shear_prime is the derivative of metric_shear</li>
<li>In the ufa_class approximation, the leading-order source term is (h_prime/2) in synchronous gauge, (-3 (phi_prime+psi_prime)) in newtonian gauge: we approximate the later by (-6 phi_prime)</li>
</ul>
</li>
<li>&ndash;&gt; (d) if some approximation schemes are turned on, enforce a few y[ ] values computed in perturb_einstein</li>
<li>&mdash;&gt; like Ma &amp; Bertschinger</li>
<li>&mdash;&gt; relax assumption dkappa~a <img class="formulaInl" alt="$^{-2}$" src="form_247.png"/> (like in CAMB)</li>
<li>&mdash;&gt; also relax assumption cb2~a <img class="formulaInl" alt="$^{-1}$" src="form_248.png"/></li>
<li>&mdash;&gt; intermediate quantities for 2nd order tca: shear_g at first order in tight-coupling</li>
<li>&mdash;&gt; intermediate quantities for 2nd order tca: zero order for theta_b' = theta_g'</li>
<li>-&mdash;&gt; perturbed recombination has an impact</li>
<li>&mdash;&gt; intermediate quantities for 2nd order tca: shear_g_prime at first order in tight-coupling</li>
<li>&mdash;&gt; 2nd order as in CRS</li>
<li>&mdash;&gt; 2nd order like in CLASS paper</li>
<li>&mdash;&gt; add only the most important 2nd order terms</li>
<li>&mdash;&gt; store tight-coupling values of photon shear and its derivative </li>
</ul>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b2f33c71d4aa5e7af42a1ca61ff5af1b.html">source</a></li><li class="navelem"><a class="el" href="perturbations_8c.html">perturbations.c</a></li>
    <li class="footer">Generated on Mon Oct 22 2018 16:09:37 for CLASS MANUAL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
